###########################################################################
# Alpine Linux aports
#
# https://alpinelinux.org/releases/
###########################################################################

# XXX: packagelinks problems:
#
# Most PACKAGE_BUILD_LOG_RAW links are broken, likely because logs are not
# stored on servers for a long time. It would be OK for us as soon as we start
# retrieving content for these - new logs will be fetched and stored
# and we no longer care if original files are deleted
#

{% macro alpine(version, minpackages, valid_till=None, subrepos=['community','main']) %}
{% set vversion = 'edge' if version == 'edge' else 'v' + version %}
- name: alpine_{{version|replace('.', '_')}}
  {% if version >= '3.8' and version <= '3.9' %}
  sortname: alpine_{{version|replace('.', '_0')}}
  {% endif %}
  type: repository
  desc: Alpine Linux {{version|title}}
  statsgroup: Alpine
  family: alpine
  ruleset: alpine
  minpackages: {{minpackages}}
  {% if valid_till %}
  valid_till: {{valid_till}}
  {% endif %}
  default_maintainer: fallback-mnt-alpine@repology
  sources:
    {% for subrepo in subrepos %}
    - name: {{subrepo}}
      fetcher:
        class: TarFetcher
        url: 'http://dl-cdn.alpinelinux.org/alpine/{{vversion}}/{{subrepo}}/x86_64/APKINDEX.tar.gz'
      parser:
        class: ApkIndexParser
      subrepo: {{subrepo}}
    {% endfor %}
  repolinks:
    - desc: Alpine Linux home
      url: https://alpinelinux.org/
    - desc: Alpine packages
      url: https://pkgs.alpinelinux.org/packages
  packagelinks:
    {% if version != 'edge' %}
    {% set pkgs_branch = '&branch=v' + version %}
    {% set git_branch = '?h=' + version + '-stable' %}
    {% endif %}
    - type: PACKAGE_HOMEPAGE
      url: 'https://pkgs.alpinelinux.org/packages?name={binname|quote}{{pkgs_branch}}'
    - type: PACKAGE_SOURCES
      url: 'https://git.alpinelinux.org/aports/tree/{subrepo}/{srcname}{{git_branch}}'
    - type: PACKAGE_RECIPE
      url: 'https://git.alpinelinux.org/aports/tree/{subrepo}/{srcname}/APKBUILD{{git_branch}}'
    - type: PACKAGE_RECIPE_RAW
      url: 'https://git.alpinelinux.org/aports/plain/{subrepo}/{srcname}/APKBUILD{{git_branch}}'
    - type: PACKAGE_BUILD_LOG_RAW
      url: 'https://build.alpinelinux.org/buildlogs/build-{{version|replace('.', '-')}}-x86_64/{subrepo}/{srcname}/{srcname}-{rawversion}.log'
  groups: [ all, production, alpine ]
{% endmacro %}

{{ alpine('3.8', minpackages=8500, valid_till='2020-05-01') }}
{{ alpine('3.9', minpackages=9000, valid_till='2020-11-01') }}
{{ alpine('3.10', minpackages=9000, valid_till='2021-05-01') }}
{{ alpine('3.11', minpackages=10000, valid_till='2021-11-01') }}
{{ alpine('3.12', minpackages=11000, valid_till='2022-05-01') }}
{{ alpine('3.13', minpackages=13000, valid_till='2022-11-01') }}
{{ alpine('3.14', minpackages=14000, valid_till='2023-05-01') }}
{{ alpine('3.15', minpackages=15000, valid_till='2023-11-01') }}
{{ alpine('3.16', minpackages=16000, valid_till='2024-05-23') }}
{{ alpine('3.17', minpackages=16000, valid_till='2024-11-22') }}
{{ alpine('3.18', minpackages=16000, valid_till='2025-05-09') }}
{{ alpine('3.19', minpackages=16000, valid_till='2025-11-01') }}
{{ alpine('edge', minpackages=20000, subrepos=['community', 'main', 'testing']) }}
